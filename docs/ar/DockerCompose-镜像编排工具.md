# Docker Compose - أداة ترتيب الصور

![](https://img.wiki-power.com/d/wiki-media/img/20210117130925.jpg)

Docker Compose هي أداة ترتيب الصور في Docker. نوصي باستخدام Docker Compose كوسيلة افتراضية لفتح Docker، لأنها ليست مفيدة فقط لتكوين ونشر الصور بسهولة، ولكنها أيضًا تسهل تكوين خدمات متعددة الصور وحتى تحديد ترتيب بدء تشغيلها، وهذا ما لا يمكن تحقيقه باستخدام الأوامر التقليدية.

على الرغم من أن فلسفة Docker تتمحور حول الفصل بين الصور (عملية لكل صورة)، وزيادة إعادة الاستخدام، وعدم تضمين خدمات متعددة في صورة واحدة، إلا أن هناك تطبيقات تحتاج إلى تشغيل خدمات متعددة في نفس الوقت. على سبيل المثال، تطبيق الويب التقليدي يحتاج على الأقل إلى خادم وقاعدة بيانات للتعاون. في هذه الحالة، ستحتاج إلى نشر حاويتين على الأقل، وقد يكون هناك حاجة إلى بدء تشغيل بعض الخدمات بترتيب محدد. وهذا سيزيد من التعقيد المتعلق بالصور المطلوبة والخطوات المطلوبة.

Docker Compose يجمع بين الصور المطلوبة (جميع الخدمات المطلوبة، خصائص الحاويات، تكوين الشبكة، وتوصيل محركات التخزين) وترتيبها وما إلى ذلك، في ملف YAML واحد. يمكن تشغيل هذا الملف التكويني مباشرة لتشغيل الحاويات بالطريقة والخطوات التي تحتاجها، دون الحاجة إلى التدخل اليدوي في كل حاوية. فيما يلي مثال على Docker Compose لنشر خدمة ويب:

```yaml title="compose.yaml"
version: "3"
services:
  web:
    image: beginor/geoserver:2.11.1
    container_name: geoserver-web
    hostname: geoserver-web
    ports:
      - 8080:8080
    volumes:
      - ./web/data_dir:/geoserver/data_dir
      - ./web/logs:/geoserver/logs
    restart: unless-stopped
    links:
      - database:database
  database:
    image: beginor/postgis:9.3
    container_name: postgis
    hostname: postgis
    ports:
      - 5432:5432
    volumes:
      - ./database/data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: 1q2w3e4R
    restart: unless-stopped
```

في هذا الملف YAML، تم تعريف وتشغيل مثيلي "web" و "database".

## تثبيت وتكوين Docker Compose

Docker Compose يعتمد على Docker Engine، لذا تأكد أولاً من تثبيت بيئة Docker Engine. إذا لم تكن قد قمت بالتثبيت بعد، يمكنك الرجوع إلى الدرس السابق: [**أساسيات Docker**](https://example.com/docker-basics) لتثبيت Docker Engine.

إذا كنت تستخدم عميل سطح المكتب لنظام التشغيل Windows/MacOS/Linux، فإنك لست بحاجة إلى تثبيت Docker Compose بشكل منفصل، لأنه يتم تضمينه بالفعل. يتم شرح كيفية تثبيت Docker Compose في بيئة Linux Docker Engine أدناه.

بالنسبة لأنظمة Ubuntu وDebian، استخدم الأوامر التالية لتثبيت Docker Compose:

```shell
sudo apt-get update
sudo apt-get install docker-compose-plugin
```

بالنسبة للإصدارات المعتمدة على RPM من Linux (مثل CentOS)، استخدم الأوامر التالية لتثبيت Docker Compose:

```shell
sudo yum update
sudo yum install docker-compose-plugin
```

بمجرد الانتهاء، استخدم الأمر التالي للتحقق من نجاح التثبيت:

```markdown
```shell
docker compose version
```

## كيفية استخدام Docker Compose

عمومًا، نقوم بإنشاء ملف `compose.yaml` (الإصدار القديم كان `docker-compose.yml` وهو متوافق أيضًا) ونضعه في دليل يتم تسميته باسم اسم التطبيق، على سبيل المثال `web/compose.yaml`.

لتشغيل هذا البرنامج، ما عليك سوى تنفيذ الأمر `docker compose up` في هذا الدليل، وسيتم تشغيل الخدمات وفقًا للتكوين الموجود في ملف YAML. (يمكنك تشغيله في الخلفية باستخدام الخيار `-d`)

لإيقاف تشغيل مكدس التطبيق، يمكنك استخدام الأمر `docker compose down`.

## كتابة ملف Docker Compose

الطريقة الافتراضية لفتح ملف Docker Compose هي إنشاء ملف بتنسيق YAML وتسميته افتراضيًا `compose.yaml`. فيما يلي نموذج لملف يحتوي على جميع البارامترات المتاحة (ولكن ليس دائمًا يجب استخدامها جميعًا):

```yaml title="compose.yaml"
version: "3"

services:
  service1:
    build:
      context: .
      dockerfile: Dockerfile
    image: your-image1
    command: ["python", "app.py"]
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
    networks:
      - your-network
    environment:
      - ENV_VARIABLE=value
    depends_on:
      - db

  db:
    image: mysql:5.7
    environment:
      - MYSQL_ROOT_PASSWORD=yourpassword
    volumes:
      - db-data:/var/lib/mysql

networks:
  your-network:

volumes:
  your-volume:
  db-data:
```

عادةً ما يتضمن ملف `compose.yaml` البارامترات التالية:
```

- **الإصدار**: يُستخدم فقط لعرض معلومات إصدار ملف Compose. يرتبط بإصدار محرك Docker ويمكن أن يحتوي على ميزات وصيغ جديدة في التحديثات. يرجى الرجوع إلى الوثائق الرسمية [**Compose file versions and upgrading**](https://docs.docker.com/compose/compose-file/compose-versioning/).

- **الخدمات**: تحدد الخدمات (الحاويات) المدرجة في ملف Compose هذا. كل خدمة هي حاوية مستقلة يمكن تحديد صورتها وتعيين تخطيط المنفذ والمتغيرات البيئية وما إلى ذلك.

- **container_name**: اسم الحاوية، اختياري ولكن لا يجوز تكراره.

- **الشبكات**: تحدد تكوين الشبكات بين الخدمات. يمكن إنشاء شبكات مخصصة وربط الخدمات بهذه الشبكات لتمكين التواصل بين الحاويات.

- **الأسطوانات**: تحدد تكوين تثبيت الأسطوانات للحاويات. يمكن ربط أدلة أو ملفات الحاويات بمجلدات أو ملفات في المضيف لتحقيق تخزين البيانات والمشاركة. مشابه للخيار `-v` في Docker CLI.

- **البيئة** (أو `env_file`): يُحدد اسم ومسار ملف المتغيرات البيئية للحاوية ويُحدد أن يتم تحميل المتغيرات البيئية من هذا الملف. إذا لم يتم تكوين المتغيرات البيئية، يمكن تجاهله. إذا كانت المتغيرات البيئية موجودة في الدليل الحالي واسمها `.env`، فيمكن الاستغناء عن تكوينها. مشابه للخيار `-e` في Docker CLI.

- **البناء**: تشغيل الحاوية باستخدام صورة مبنية مسبقًا. يُحدد مسار ملف Dockerfile.

- **الصورة**: يُحدد الصورة التي تُستخدم للحاوية. يمكن استخدام صور من مستودعات الصور العامة أو تحديد ملف Dockerfile محلي.

- **المنافذ**: تعرف علاقة تعيين المنفذ بين الحاوية والمضيف، ويمكن تحديد البروتوكول (TCP أو UDP) المعين. مشابه للخيار `-p` في Docker CLI.

- **depends_on**: يحدد العلاقات التبعية بين الخدمات. يمكن تحديد أحد أو أكثر من أسماء الخدمات للإشارة إلى أن هذه الخدمة تعتمد على تشغيل تلك الخدمات.

- **إعادة التشغيل**: يحدد استراتيجية إعادة تشغيل الحاوية. يمكن تعيينها إلى `no` (لا تعاد تشغيل تلقائيًا)، `always` (تعاد تشغيلها دائمًا)، `unless-stopped` (تعاد تشغيلها ما لم يتم إيقاف الحاوية يدويًا)، أو `on-failure` (تعاد تشغيلها فقط عند حدوث خطأ). مشابه لخيار `--restart` في Docker CLI.

- **الأمر**: يحدد الأمر الذي يجب تنفيذه عند بدء تشغيل الحاوية، ويمكن استخدامه لتجاوز الأمر الافتراضي في صورة الحاوية.

- **volumes_from**: يحدد الحاوية التي يجب أن تأتي منها الأسطوانات.

## بعض الأوامر الشائعة لـ Docker Compose

اليمكن تحميلها هنا.

- `docker compose up`: يقوم ببناء الصور المعرفة في الـ compose ويقوم بتشغيل الحاويات. إذا كان ذلك ضروريًا ، سيتم بناء الصور تلقائيًا (إذا تغير ملف Dockerfile) ثم يتم تشغيل جميع الخدمات المعرفة. إذا كنت بحاجة إلى بدء التشغيل في الخلفية ، يمكنك إضافة المعلمة `-d`.

- `docker compose down`: يقوم بإيقاف وإزالة جميع الحاويات والشبكات والأقراص المعرفة في الـ compose. سيتوقف عن تشغيل الخدمات ويقوم بتنظيف جميع الموارد المتعلقة.

- `docker compose pull`: يستخدم لجلب جميع الصور المعرفة في الـ compose أو لتحديث الصور.

- `docker compose start`: يبدأ الحاويات الموجودة بالفعل في الـ compose دون إعادة إنشاء الحاويات أو إعادة بناء الصور.

- `docker compose stop`: يقوم بإيقاف الحاويات الموجودة بالفعل في الـ compose دون إزالتها.

- `docker compose restart`: يعيد تشغيل الحاويات الموجودة بالفعل في الـ compose.

- `docker compose pause`: يوقف مؤقتاً الحاويات الموجودة بالفعل في الـ compose ويجعلها تتوقف عن التشغيل مؤقتا.

- `docker compose unpause`: يستأنف التشغيل للحاويات الموقفة مؤقتاً في الـ compose.

- `docker compose ps`: يعرض حالة **جميع** الحاويات التي تعمل في الـ compose.

- `docker compose logs`: يعرض سجل الإخراج للحاويات في الـ compose.

- `docker compose exec`: يُستخدم لتنفيذ أوامر في الحاويات المعرفة في الـ compose. مثلاً: `docker exec -it [اسم الـ compose] /bin/bash`

هذه بعض الأوامر الشائعة. يمكنك أيضًا تنفيذ `docker compose --help` لعرض المزيد من الأوامر المتاحة.

## المتغيرات البيئية

في Docker Compose ، على الرغم من أن المتغيرات البيئية ليست إلزامية ، إلا أنه من المستحسن استخدامها بشكل متكرر للأسباب التالية:

1. **المرونة والقابلية للتكوين**: يمكن تعديل معلومات تكوين التطبيق بسهولة دون الحاجة إلى تعديل صور Docker أو إعادة بناء الحاويات.

2. **الأمان والعزل**: عن طريق تخزين المعلومات الحساسة في المتغيرات البيئية بدلاً من كتابتها مباشرة في الشيفرة أو ملف التكوين ، يمكن زيادة أمان التطبيق من خلال منح الامتياز الخاص بالمتغيرات البيئية.

3. **التوافق عبر المنصات**: يمكن نقل معلومات التكوين المختلفة عبر أنظمة تشغيل أو منصات مختلفة باستخدام المتغيرات البيئية دون الحاجة إلى تعديل ملفات التكوين أو الشيفرة.

4. **تبسيط النشر والإدارة**: من خلال استخدام المتغيرات البيئية بشكل موحد لتكوين معلمات مختلفة للحاويات ، يمكن تقليل تكرار المحتوى في ملفات التكوين وجعل العملية أكثر وضوحًا وصيانةً.

5. **التكامل والأتمتة**: يمكن توجيه معلمات تكوين التطبيق تلقائيًا إلى حاويات Docker من خلال التكامل مع أدوات CI/CD والأتمتة.

المتغيرات البيئية تتمثل عادة في ملف يحمل الامتداد `.env` ويتم إنشاؤه عادة في نفس مستوى ملف `compose.yaml`. فيما يلي مثال:

```dotenv title=".env"
TAG=v1.5
```

يمكن الرجوع إلى المتغيرات البيئية مباشرة في ملف `compose.yaml`:

```yaml title="compose.yaml"
services:
  web:
    image: "webapp:${TAG}"
```

## نصائح

هناك موقع ويب يُس

- [استخدام Docker Compose بدلاً من تشغيل Docker](https://beginor.github.io/2017/06/08/use-compose-instead-of-run.html)
- [تثبيت Docker Compose](https://docs.docker.com/compose/install/#prerequisites)
- [شرح معلمات ملف القالب في Docker-Compose](https://blog.51cto.com/14154700/2466054)
- [الآن، يمكن استخدام Docker Compose مع جهاز Synology!](https://www.himiku.com/archives/docker-compose-for-synology-nas.html)
- [Docker - من المبتدئين إلى الاحتراف](https://docker-practice.github.io/zh-cn/)
- [سلسلة Docker - تعرف على ملف تكوين Docker Compose](https://blognas.hwb0307.com/linux/docker/3880)

> عنوان النص: <https://wiki-power.com/>
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.