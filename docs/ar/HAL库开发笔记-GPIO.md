# مذكرات تطوير مكتبة HAL - GPIO

## المبادئ الأساسية

GPIO هو اختصار لـ **منفذ إدخال/إخراج عام** (General Purpose Input Output).

![](https://img.wiki-power.com/d/wiki-media/img/20200615205256.jpg)

لنأخذ شريحة F103C8T6 كمثال (كما في الصورة أعلاه)، بجانب الأوصال الملونة (أوصال الطاقة وبعض الوظائف الأخرى)، يُسمى كل شيء بغض النظر عنه بـ GPIO. وهذا يوضح مدى تعميم استخدامه.

وظيفة GPIO هي إدخال وإخراج إشارات كهربائية. دعونا نلقي نظرة على البنية الداخلية لها:

![](https://img.wiki-power.com/d/wiki-media/img/20200615211744.jpg)

- الأوصال I/O على الجانب الأيمن هي أوصال الشريحة الفعلية. والثنائيات القطبية (الدوبليرات) الحماية في الأعلى والأسفل تمنع إلى حد ما تدمير الشريحة بواسطة جهد غير طبيعي من الخارج.
- الإطار المخطط باللون الأحمر هو وضع الإدخال (الشريحة تقرأ الإشارات الخارجية). المقاومتين المفتوحين مع مفاتيح السحب للأعلى وللأسفل تُستخدم لتحقيق وضع الإدخال مع السحب للأعلى والسحب للأسفل. إذا لم تُغلق المفاتيحين، يُطلق عليها اسم وضع الإدخال العائم (ليس لديها مستوى مرجعي). هذه الأوضاع الثلاثة تُقرأ بوصفها كميات رقمية (مستوى عالي/منخفض). بالإضافة إلى ذلك، هناك وضع الإدخال التناظري، كما يوحي الاسم، يتم قراءة الإشارة التناظرية مباشرة من الدبوس. (ستتم مناقشة وضع الإدخال متعدد الاستخدامات لاحقًا).
- الإطار المخطط باللون الأزرق هو وضع الإخراج. هناك 4 أنماط للإخراج: الدفع والسحب، الفتح والدفع، الدفع متعدد الاستخدامات، الفتح متعدد الاستخدامات.

### أوضاع الإدخال والإخراج

أوضاع الإدخال:

- **الإدخال العائم**: لا سحب للأعلى ولا سحب للأسفل، وهو الوضع الافتراضي بعد إعادة تعيين STM32.
- **الإدخال مع سحب للأعلى**: إغلاق مفتاح السحب للأعلى يجعل مستوى المرجع دائمًا عاليًا، وعندما تكون الإشارة الواردة منخفضة، يتم تنشيطها.
- **الإدخال مع سحب للأسفل**: إغلاق مفتاح السحب للأسفل يجعل مستوى المرجع دائمًا منخفضًا، وعندما تكون الإشارة الواردة عالية، يتم تنشيطها.
- **الإدخال التناظري**: في هذا الوضع، لا يوجد سحب للأعلى ولا سحب للأسفل، ولا تمر عبر مقومات TTL، بل يتم قراءة الإشارة التناظرية مباشرة من الدبوس. (سيتم الرجوع إلى وضع الإدخال متعدد الاستخدامات في وقت لاحق).

أوضاع الإخراج:

- **الإخراج مفتوح**: الإخراج المفتوح يشير إلى فتح تصريف N-MOS السفلي (الذي يشكل الأوصال السفلية). نفهم أن الترانزستور N-MOS هو جهاز يتحكم بالجهد. لنفترض أنه مثل صنبور المياه، عند إدخال إشارة منخفضة على البوابة (الدبوس الأيسر) لترانزستور N-MOS، سيتوصل.
- **الإخراج الدافع**: هناك نوعان من وضع الدفع، النوع الأول هو تمرير إشارة منخفضة إلى بو

إذا تم تكوينه بشكل صحيح، يمكن تشغيل مصابيح LED المستخدمين بمجرد توصيل الطاقة. إذا كنت ترغب في إضافة تأثير وميض للمصابيح، فما عليك سوى إضافة بضعة أسطر من الشيفرة في منطقة الشيفرة الخاصة بالمستخدم في الحلقة الرئيسية:

```c title="main.c"
/* USER CODE BEGIN 3 */

HAL_Delay(500);
HAL_GPIO_TogglePin(GPIOD, GPIO_PIN_4);
HAL_GPIO_TogglePin(GPIOI, GPIO_PIN_3);

}
/* USER CODE END 3 */
```

بهذا يمكنك تحقيق تأثير وميض للمصابيح.

## التحكم بالمصابيح باستخدام الأزرار

بعد أن قمنا بفهم كيفية التحكم في مخرجات GPIO لمصابيح LED، سنقوم الآن بفهم كيفية استخدام الأزرار للتحكم في المدخلات GPIO.

### تكوين GPIO في CubeMX

بعد تكوين موصلات GPIO التي تحتوي على مصابيح LED وفق الطريقة المذكورة أعلاه، يمكنك بسهولة تكوين موصلات GPIO التي تتحمل الأزرار باستناد إلى خريطة الدارة الكهربائية للوحة التطويرية:

![](https://img.wiki-power.com/d/wiki-media/img/20210205150422.png)

ثم يجب تعيين هذه الموصلات GPIO (PI8) كإدخال (GPIO_Input) واختيار مقاومة توصيل داخلية (Pull-up) ومن ثم يتم إنشاء الشيفرة.

### تكوين GPIO في الشيفرة

في منطقة الشيفرة الخاصة بالمستخدم في الحلقة الرئيسية، يمكنك إضافة الشيفرة التالية:

```c title="main.c"
/* USER CODE BEGIN 3 */

if(HAL_GPIO_ReadPin(KEY1_GPIO_Port,KEY1_Pin)==0)
{
	HAL_Delay(100);
	if(HAL_GPIO_ReadPin(KEY1_GPIO_Port,KEY1_Pin)==0)
	{
		HAL_GPIO_WritePin(LED1_GPIO_Port,LED1_Pin,GPIO_PIN_RESET);
	}
}else{
	HAL_GPIO_WritePin(LED1_GPIO_Port,LED1_Pin,GPIO_PIN_SET);
}

}
/* USER CODE END 3 */
```

بهذا يمكنك تحقيق تأثير تشغيل المصباح عند الضغط على الزر وإيقافه عندما ترفع الإصبع عن الزر.

الكثيرون قد لا يفهمون ماذا تعني المتغيرات `GPIO_PIN_SET` و` GPIO_PIN_RESET`. في الواقع، وظيفة هذين المتغيرين هي تعيين مستوى الجهد العالي أو المنخفض لموصلات GPIO فقط. وسيتعين على الفعل معرفة ما إذا كان المصباح مضاءً أم مغلقًا بناءً على خريطة الدارة الكهربائية.

بالإضافة إلى ذلك، وظيفة `HAL_Delay(100)` هي للتعامل مع تقلبات الإشارة أثناء الضغط على الزر. ومع ذلك، يجب ملاحظة أن وظيفة `HAL_Delay()` تعتمد على التحقق بشكل متكرر وتؤدي إلى استهلاك موارد وبالتالي قد تسبب تجميدًا. في المقالة القادمة، سنستخدم انقطاعات العتاد للتعامل مع هذا العيب.

## المراجع والشكر

- [دليل STM32CubeMX - الجزء الثاني -- الاستخدام الأساسي (إنشاء مشروع لتشغيل مصباح LED)](https://blog.csdn.net/as480133937/article/details/98947162)
- [دورة عملية STM32CubeMX (الجزء الثاني) - تحكم في مصباح باستخدام الأزرار](https://blog.csdn.net/weixin_43892323/article/details/104343933)

> عنوان النص: <https://wiki-power.com/>
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.