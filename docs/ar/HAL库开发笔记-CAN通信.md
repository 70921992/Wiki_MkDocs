# ูุฐูุฑุงุช ุชุทููุฑ ููุชุจุฉ HAL - ุงุชุตุงู CAN ๐ง

ูุฐุง ุงูููุงู ูุณุชูุฏ ุฅูู ูุฌููุนุฉ ุชุทููุฑ RobotCtrl ุงููุตููุฉ ุฐุงุชูุงูุ ูููุญุฉ ุงูุฏุงุฑุฉ ุงููุตุบุฑุฉ ููููุงุฉ ุชุญุชูู ุนูู STM32F407ZET6ุ ูุงุณุชุฎุฏุงู ุงุชุตุงู CAN ูุน ุฑูุงูุฉ TJA1050. ููุญุตูู ุนูู ูุฎุทุทุงุช ุงูุฏุงุฑุฉ ูุดุฑุญ ููุตูุ ูุฑุฌู ุงูุงุทูุงุน ุนูู [**RobotCtrl - STM32 ้็จๅผๅๅฅไปถ**](to_be_replace[3]).

## ุฎุทูุงุช ุจุณูุทุฉ ูุงุฎุชุจุงุฑ ุงูุญููุฉ ุงููุบููุฉ

### ุงูุชูููู ุงูุฏุงุฎูู ุจุงุณุชุฎุฏุงู CubeMX

1. ุงูุชุญ ุตูุญุฉ `CAN1` ุฃู `CAN2` ูู ุงูุฌุงูุจ ุงูุฃูุณุฑ ููู ุจุชุญุฏูุฏ ุฎูุงุฑ `Activated`. ุซูุ ูู ุตูุญุฉ ุงููุนููุงุชุ ูู ุจุชูููู ูุฐู ุงููุนููุงุช:
   1. ุงุถุจุท `Prescaler (for Time Quantum)` ุนูู `6`ุ ูุงุถุจุท `Time Quanta in Bit Segment 1` ู `Time Quanta in Bit Segment 2` ุนูู `3 Times`. ูุฐุง ุงูุฌูุน ูููู ุจุถุจุท ูุนุฏู ุงูุจุช ุนูู 1Mbps (ุงูุฃุนูู).
   2. ุถุจุท `ReSynchronization Jump Width` ุนูู `1 Time`ุ ููุฐุง ูู ุงูุญุฏ ุงูุฃูุตู ุงูุฐู ูููู ุชุนุฏููู ุนูุฏ ุฅุนุงุฏุฉ ุงููุฒุงููุฉ.
   3. ูู ุจุถุจุท `Operating Mode` ุนูู `Loopback`ุ ููู ูุณุชุฎุฏู ูู ุงุฎุชุจุงุฑ ุงูุญููุฉ ุงููุบููุฉ.
2. ูู ุนูุงูุฉ ุชุจููุจ `NVIC Settings`ุ ูู ุจุชูููู `CANx RX0 interrupts`.

### ุงูุชูููู ูู ุงูุดููุฑุฉ

ูู ุจุฅูุดุงุก ููู `can.c` ูู ูุดุฑูุนู ููู ุจุชูููู ูุฑุดุญุงุช ุงูุงุชุตุงู. ูู ูุฐุง ุงููุซุงูุ ุชู ุชูููู ูุถุน ุงููุงุฆูุฉุ ูุชู ุชุตููุฉ ุงููููุฉ ุงูููุชุฏุฉ `0x2233` ูุงููููุฉ ุงูููุงุณูุฉ `0`:

```c title="can.c"/*
 * ุงุณู ุงูุฏุงูุฉ: CAN_Filter_Config
 * ุงููุตู: ุชูููู ูุฑุดุญุงุช CAN
 * ุงูุฅุฏุฎุงู: ูุง ุดูุก
 * ุงูุฅุฎุฑุงุฌ: ูุง ุดูุก
 * ุงูุงุณุชุฏุนุงุก: ุงุณุชุฏุนุงุก ุฏุงุฎูู
 */
static void CAN_Filter_Config(void) {
	CAN_FilterTypeDef CAN_FilterTypeDef;

	/* ุชููุฆุฉ ูุฑุดุญุงุช CAN */
	CAN_FilterTypeDef.FilterBank = 0;						// ูุฌููุนุฉ ุงููุฑุดุญ 0
	CAN_FilterTypeDef.FilterMode = CAN_FILTERMODE_IDLIST;	// ุชุนูู ูู ูุถุน ุงููุงุฆูุฉ
	CAN_FilterTypeDef.FilterScale = CAN_FILTERSCALE_32BIT;	// ุนุฑุถ ุงููุฑุดุญ ูู 32 ุจุช ูุฑุฏู.
	/* ุชูููู ุงููุฑุดุญุ ุญูุซ ูุชู ุงูููุงุฑูุฉ ููููุง ููุญุชูู ุงูุนูุงูุงุชุ ูุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฐู ุงูุนูุงูุฉุ ูุชู ุงูุชุฎูุต ูููุงุ ูุฅุฐุง ุชู ุงูุนุซูุฑ ุนูู ูุฐู ุงูุนูุงูุฉุ ุณูุชู ุชุฎุฒูููุง ูู FIFO0. */

	CAN_FilterTypeDef.FilterIdHigh = ((((uint32_t) 0x2233 << 3) | CAN_ID_EXT
			| CAN_RTR_DATA) & 0xFFFF0000) >> 16;		// ุฃุนูู ุฌุฒุก ูููููุฉ ุงูุชู ูุฌุจ ุชุตููุชูุง
	CAN_FilterTypeDef.FilterIdLow = (((uint32_t) 0x2233 << 3) | CAN_ID_EXT
			| CAN_RTR_DATA) & 0xFFFF; // ุงูุฌุฒุก ุงูุณููู ูููููุฉ ุงููุทููุจ ุชุตููุชูุง
	CAN_FilterTypeDef.FilterMaskIdHigh = 0;		// ุงูุฌุฒุก ุงูุนููู ูููููุฉ ุงูุซุงููุฉ
	CAN_FilterTypeDef.FilterMaskIdLow = 0;			// ุงูุฌุฒุก ุงูุณููู ูููููุฉ ุงูุซุงููุฉ
	CAN_FilterTypeDef.FilterFIFOAssignment = CAN_FILTER_FIFO0;	// ุชุนููู ุงููุฑุดุญ ุฅูู FIFO0
	CAN_FilterTypeDef.FilterActivation = ENABLE;			// ุชูููู ุงููุฑุดุญ
	HAL_CAN_ConfigFilter(&hcan1, &CAN_FilterTypeDef);
}
```

### ุงูุงุฎุชุจุงุฑ

ุงูุชุญ ูุฏูุฑ ุงูุฃุฌูุฒุฉ ููุชุญูู ููุง ุฅุฐุง ูุงู ุงูุฌูุงุฒ ูุฏ ุธูุฑ ุจุงููุนู. ุฅุฐุง ูู ุชุฌุฏ ุงูุฌูุงุฒ ุฃู ุฅุฐุง ูุงู ููุงู ุนูุงูุฉ ุชุนุฌุจ ุตูุฑุงุกุ ููุฑุฌู ุฒูุงุฑุฉ ูููุน ST ูุชูุฒูู ูุดุบู [STM32 Virtual COM Port Driver](https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-utilities/stsw-stm32102.html).

ุฅุฐุง ูู ูุชู ุงูุชุนุฑู ุนูู ุงูุฌูุงุฒ ุจุดูู ุตุญูุญ ุญุชู ุจุนุฏ ุชุซุจูุช ุงููุดุบูุ ููููู ูุญุงููุฉ ุถุจุท "Minimum Heap Size" ูู CubeMX - `Project Manager` - `Project` - `Linker Settings` ุฅูู `0x600` ุฃู ูููุฉ ุฃุนูู.

ุจุนุฏ ุฐููุ ูู ุจูุชุญ ุฃุฏุงุฉ ุงูุดุฑูุท (ุจุฃู ูุนุฏู ููู) ููู ุจุฅุฑุณุงู ุฃู ุญุฑูุ ูุณูู ุชุชููู ููุณ ุงูุญุฑู ูุฑุฏ.

## ูุฑุงุฌุน ูุดูุฑ

- [STM32CubeMX ูููุชุจุฉ HAL - ุชุนูู ุงูุงุฎุชุจุงุฑ ุงูุจุณูุท ููู CAN](https://blog.csdn.net/weixin_45209978/article/details/119850600)

> ุนููุงู ุงููุต: <https://wiki-power.com/>
> ูุชู ุญูุงูุฉ ูุฐุง ุงูููุงู ุจููุฌุจ ุงุชูุงููุฉ [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)ุ ููุฑุฌู ุฐูุฑ ุงููุตุฏุฑ ุนูุฏ ุฅุนุงุฏุฉ ุงููุดุฑ.

> ุชูุช ุชุฑุฌูุฉ ูุฐู ุงููุดุงุฑูุฉ ุจุงุณุชุฎุฏุงู ChatGPTุ ูุฑุฌู [**ุชุฒููุฏูุง ุจุชุนูููุงุชูู**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) ุฅุฐุง ูุงูุช ููุงู ุฃู ุญุฐู ุฃู ุฅููุงู.