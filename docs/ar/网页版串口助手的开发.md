# تطوير مساعد المنفذ التسلسلي على الويب

Demo: **<https://serial.wiki-power.com/>**  
مستودع المشروع: [**linyuxuanlin/Serial_on_Web**](https://github.com/linyuxuanlin/Serial_on_Web)

يعتمد هذا المشروع على [**web-serial-terminal**](https://github.com/rafaelaroca/web-serial-terminal) ويضيف [**debugout.js**](https://github.com/inorganik/debugout.js) لتحقيق وظيفة الطباعة والتصدير. وفيما يلي الخطوات التفصيلية:

### إضافة كود `debug.js`

```js
// save all the console.logs
function debugout() {
  var self = this;

  // OPTIONS
  self.realTimeLoggingOn = true; // log in real time (forwards to console.log)
  self.useTimestamps = false; // insert a timestamp in front of each log
  self.useLocalStorage = false; // store the output using window.localStorage() and continuously add to the same log each session
  self.recordLogs = true; // set to false after you're done debugging to avoid the log eating up memory
  self.autoTrim = true; // to avoid the log eating up potentially endless memory
  self.maxLines = 2500; // if autoTrim is true, this many most recent lines are saved
  self.tailNumLines = 100; // how many lines tail() will retrieve
  self.logFilename = "log.txt"; // filename of log downloaded with downloadLog()
  self.maxDepth = 25; // max recursion depth for logged objects

  // vars
  self.depth = 0;
  self.parentSizes = [0];
  self.currentResult = "";
  self.startTime = new Date();
  self.output = "";

  this.version = function () {
    return "0.5.0";
  };

/*
		طرق المستخدم
	*/
  this.getLog = function () {
    var retrievalTime = new Date();
    // إذا كان التسجيل متوقفًا ، فسيعرف المطور لماذا ليس لديه أي سجلات
    if (!self.recordLogs) {
      self.log("[debugout.js] تسجيل السجلات متوقف.");
    }
    // إذا كنت تستخدم التخزين المحلي ، فاحصل على القيم
    if (self.useLocalStorage) {
      var saved = window.localStorage.getItem("debugout.js");
      if (saved) {
        saved = JSON.parse(saved);
        self.startTime = new Date(saved.startTime);
        self.output = saved.log;
        retrievalTime = new Date(saved.lastLog);
      }
    }
    return (
      self.output +
      "\n---- تم استرداد السجل: " +
      retrievalTime +
      " ----\n" +
      self.formatSessionDuration(self.startTime, retrievalTime)
    );
  };
  // يقبل عددًا اختياريًا أو يستخدم الافتراضي لعدد الأسطر
  this.tail = function (numLines) {
    var numLines = numLines || self.tailLines;
    return self.trimLog(self.getLog(), numLines);
  };
  // يقبل سلسلة للبحث عنها
  this.search = function (string) {
    var lines = self.output.split("\n");
    var rgx = new RegExp(string);
    var matched = [];
    // لا يمكن استخدام Array.prototype.filter () البسيط هنا
    // لأننا بحاجة إلى إضافة رقم الخط
    for (var i = 0; i < lines.length; i++) {
      var addr = "[" + i + "] ";
      if (lines[i].match(rgx)) {
        matched.push(addr + lines[i]);
      }
    }
    var result = matched.join("\n");
    if (result.length == 0) result = 'لم يتم العثور على "' + string + '".';
    return result;
  };
  // يقبل الخط البدء وكم عدد الأسطر بعد الخط البدء الذي تريده
  this.getSlice = function (lineNumber, numLines) {
    var lines = self.output.split("\n");
    var segment = lines.slice(lineNumber, lineNumber + numLines);
    return segment.join("\n");
  };
  // يقوم بتنزيل السجل على الفور - للاستخدام في متصفح سطح المكتب
  this.downloadLog = function () {
    var file = "data:text/plain;charset=utf-8,";
    var logFile = self.getLog();
    var encoded = encodeURIComponent(logFile);
    file += encoded;
    var a = document.createElement("a");
    a.href = file;
    a.target = "_blank";
    a.download = self.logFilename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };
  // يمسح السجل
  this.clear = function () {
    var clearTime = new Date();
    self.output = "---- تم مسح السجل: " + clearTime + " ----\n";
    if (self.useLocalStorage) {
      // التخزين المحلي
      var saveObject = {
        startTime: self.startTime,
        log: self.output,
        lastLog: clearTime,
      };
      saveObject = JSON.stringify(saveObject);
      window.localStorage.setItem("debugout.js", saveObject);
    }
    if (self.realTimeLoggingOn) console.log("[debugout.js] clear()");
  };
  // يسجل السجل
  this.log = function (obj) {
    // تسجيل في الوقت الحقيقي
    if (self.realTimeLoggingOn) console.log(obj);
    // تسجيل السجل
    var type = self.determineType(obj);
    if (type != null && self.recordLogs) {
      var addition = self.formatType(type, obj);
      // الطابع الزمني ، المنسق للإيجاز
      if (self.useTimestamps) {
        var logTime = new Date();
        self.output += self.formatTimestamp(logTime);
      }
      self.output += addition;
      if (self.autoTrim) self.output = self.trimLog(self.output, self.maxLines);
      // التخزين المحلي
      if (self.useLocalStorage) {
        var last = new Date();
        var saveObject = {
          startTime: self.startTime,
          log: self.output,
          lastLog: last,
        };
        saveObject = JSON.stringify(saveObject);
        window.localStorage.setItem("debugout.js", saveObject);
      }
    }
    self.depth = 0;
    self.parentSizes = [0];
    self.currentResult = "";
  };
  /*
		طرق لبناء السجل
	*/

// مثل typeof ولكن يصنف الكائنات من نوع 'object'
// يتم الاحتفاظ بها منفصلة عن formatType() حتى تتمكن من استخدامها في أي وقت تريد!
this.determineType = function (object) {
  if (object != null) {
    var typeResult;
    var type = typeof object;
    if (type == "object") {
      var len = object.length;
      if (len == null) {
        if (typeof object.getTime == "function") {
          typeResult = "Date";
        } else if (typeof object.test == "function") {
          typeResult = "RegExp";
        } else {
          typeResult = "Object";
        }
      } else {
        typeResult = "Array";
      }
    } else {
      typeResult = type;
    }
    return typeResult;
  } else {
    return null;
  }
};
// تنسيق النوع وفقًا لذلك ، بشكل متكرر إذا لزم الأمر
this.formatType = function (type, obj) {
  if (self.maxDepth && self.depth >= self.maxDepth) {
    return "... (تم الوصول إلى الحد الأقصى للعمق)";
  }

لا يوجد ترجمة لهذه المقالة حيث أنها تحتوي على كود برمجي وليس نص عادي.

```
/*
    بدء / استئناف السجل
*/
if (self.useLocalStorage) {
    var saved = window.localStorage.getItem("debugout.js");
    if (saved) {
        saved = JSON.parse(saved);
        self.output = saved.log;
        var start = new Date(saved.startTime);
        var end = new Date(saved.lastLog);
        self.output += "\n---- نهاية الجلسة: " + saved.lastLog + " ----\n";
        self.output += self.formatSessionDuration(start, end);
        self.output += "\n\n";
    }
}
self.output += "---- بدء الجلسة: " + self.startTime + " ----\n\n";
}
```

### إضافة زر تنزيل السجل

بعد العبارة `<button id="SerialConnectButton" type="button" disabled>Connect</button>`، أضف:

```html
<button onclick="bugout.downloadLog();">تنزيل السجل</button>
```

### استدعاء الكائن

ضع العبارة التالية في `<script>`:

```html
var bugout = new debugout();
```

### تسجيل السجل

بعد `term.write(chunk);`، أضف:

```html
bugout.log(chunk);
```

## المراجع والشكر

- [rafaelaroca/web-serial-terminal](https://github.com/rafaelaroca/web-serial-terminal)
- [inorganik/debugout.js](https://github.com/inorganik/debugout.js)
- [حدث النقر](https://www.w3school.com.cn/jsref/event_onclick.asp)
- [كيفية قراءة وكتابة ملفات txt في js؟ (الجزء الذي ينقذ الوضع)](https://www.cnblogs.com/simuhunluo/p/8109429.html)
- [أخيرًا وجدتك! كيفية حفظ سجل console.log في ملف؟](https://segmentfault.com/a/1190000009426931)

> عنوان النص: <https://wiki-power.com/>  
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.