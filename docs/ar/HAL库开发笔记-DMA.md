# ملاحظات تطوير مكتبة HAL - DMA

يسمح DMA (Direct Memory Access) بالاتصال المباشر بين أجهزة الأجهزة ذات السرعات المختلفة دون الحاجة إلى الاعتماد على حمل الانقطاعات الكبيرة لوحدة المعالجة المركزية.

## المبادئ الأساسية

### ما هو DMA

يوفر DMA نقل البيانات السريع بين الأجهزة الخارجية / الذاكرة أو الذاكرة / الذاكرة دون الحاجة إلى استخدام موارد وحدة المعالجة المركزية.

![](https://img.wiki-power.com/d/wiki-media/img/20210404153423.png)

كما هو موضح في الشكل أعلاه ، يحتوي سلسلة STM32F4 على متحكمي DMA اثنين ، بمجموع 12 قناة (DMA1 به 7 قنوات ، DMA2 به 5 قنوات). يشارك متحكم DMA حافلة البيانات الكلية لنواة Cortex-M3.

ببساطة ، عندما يكون المعالج المركزي كسولًا لنقل سلسلة كبيرة من البيانات إلى مكان آخر ، أو عندما يكون لديه أشياء أكثر أهمية للقيام بها ، فيمكنه إرسال هذه المهمة إلى DMA للقيام بها ، وبمجرد الانتهاء من DMA / الحصول على مشكلة ، يمكن للمعالج المركزي أن يخبر.

### سيناريوهات استخدام DMA

- **الاتصال المتسلسل**: الحالة الأكثر شيوعًا ، عندما يتم قراءة أو كتابة كمية كبيرة من البيانات من المنفذ التسلسلي ، يتم ترك المعالج المركزي للتعامل مع DMA. يمكن هذا تحرير المعالج المركزي والسماح له بالتعامل مع أشياء أكثر أهمية.
- **ADC**: عادةً ما يتم استخدام DMA في وضع المسح الضوئي للقناة عند الحاجة إلى ADC.
- **قراءة / كتابة بطاقة SD**: عند الحاجة إلى قراءة / كتابة كمية كبيرة من البيانات في بطاقة SD ، يتم استخدام DMA عادةً.

### اتجاه نقل DMA

- **P2P** (من الجهاز الطرفي إلى الجهاز الطرفي).
- **P2M** (من الجهاز الطرفي إلى الذاكرة) : يستخدم عادةً عندما يرسل المستشعر القراءة عبر المنفذ التسلسلي إلى الميكروكونترولر.
- **M2P** (من الذاكرة إلى الجهاز الطرفي) : يستخدم عادةً عندما يرسل الميكروكونترولر البيانات عبر المنفذ التسلسلي إلى المحرك.
- **M2M** (من الذاكرة إلى الذاكرة) : نقل البيانات داخل MCU ، وهو شائع في نقل البيانات بين المخازن المؤقتة أو قراءة / كتابة البيانات من / إلى المخزن المؤقت. يمكن لـ DMA2 فقط القيام بعمليات M2M.

### وضع نقل DMA

- **DMA_Mode_Normal** : الوضع العادي. يتوقف DMA بعد الانتهاء من المهمة ، وإذا كانت هناك حاجة للاستخدام مرة أخرى ، فيجب تشغيله يدويًا مرة أخرى.
- **DMA_Mode_Circular** : وضع النقل الدائري. عندما ينتهي النقل ، يقوم الجهاز بإعادة تحميل مسجل كمية البيانات المنقولة تلقائيًا ، ويقوم بالتالي بنقل البيانات في الدورة التالية.

### مراجع وظائف DMA الشائعة

#### إرسال بيانات DMA المتسلسلة

```c
HAL_UART_Transmit_DMA(UART_HandleTypeDef *huart, uint8_t *pData, uint16_t Size)
```

الوظيفة: إرسال بيانات محددة عبر DMA.  
المعلمات:

- **UART_HandleTypeDef \*huart** : اسم مستعار UATR (مثل: UART_HandleTypeDef huart1 -> huart1)
- **\*pData** : البيانات التي يجب إرسالها
- **Size** : عدد البايتات المراد إرسالها

مثال:

```c
HAL_UART_Transmit_DMA(&huart1, (uint8_t *)Senbuff, sizeof(Senbuff));  // إرسال مصفوفة Senbuff عبر المنفذ التسلسلي
```

#### استقبال بيانات DMA المتسلسلة

```c
HAL_UART_Receive_DMA(UART_HandleTypeDef *huart, uint8_t *pData, uint16_t Size)
```

الوظيفة: استقبال بيانات محددة عبر DMA.  
المعلمات:

- **UART_HandleTypeDef \*huart** : اسم مستعار UATR (مثل: UART_HandleTypeDef huart1 -> huart1)
- **\*pData** : مصفوفة لتخزين البيانات المستقبلة
- **Size** : عدد البايتات المراد استقبالها

مثال:

```c
HAL_UART_Receive_DMA(&huart1, (uint8_t *)Recbuff, sizeof(Recbuff));  // استقبال المنفذ التسلسلي وتخزينه في مصفوفة Recbuff
```

#### وظيفة استعادة DMA المتسلسلة

```c
HAL_UART_DMAResume(&huart1)
```

الوظيفة: استئناف نقل DMA
القيمة المُرجَعة: 0 (جاري الاستئناف) ؛ 1 (اكتمل الاستئناف)

## تجربة نقل البيانات عبر DMA للتسلسل الزمني

### تكوين DMA داخل CubeMX

يرجى الانتقال إلى المقالة [**HAL 库开发笔记 - 串口通信**](https://wiki-power.com/ar/HAL%E5%BA%93%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1) لتكوين المنافذ السلسلية.

بعد تكوين منافذ USART ومقاطع NVIC ، يرجى التبديل إلى علامة التبويب `DMA Settings` وفقًا للتكوين الموضح في الصورة التالية:

![](https://img.wiki-power.com/d/wiki-media/img/20210404165541.png)

- انقر فوق `Add` لإضافة القناة (USART1_RX و USART1_TX)
- ضبط أولوية كليهما على `Medium` (أولوية متوسطة)
- وضع نقل DMA هو `Normal` (الوضع العادي)
- عنوان الذاكرة الداخلية DMA يزيد تلقائيًا ، ويتم زيادة بايت واحد في كل مرة (بايت)

ثم ، في علامة التبويب `System Core` ، يرجى العثور على `DMA` وإضافة عنصر `MEMTOMEM` كما هو موضح في الصورة التالية:

![](https://img.wiki-power.com/d/wiki-media/img/20210404170002.png)

### تكوين DMA داخل الشفرة

```c title="main.c"
/* USER CODE BEGIN Init */

uint8_t Senbuff[] = "Serial Output Message by DMA \r\n";  // رسالة مخصصة للإرسال

/* USER CODE END Init */

......

/* USER CODE BEGIN 3 */

HAL_UART_Transmit_DMA(&huart1, (uint8_t *)Senbuff, sizeof(Senbuff));
HAL_Delay(1000);

}
/* USER CODE END 3 */
```

بعد حرق البرنامج ، يمكنك فتح مساعد السلسلة الزمنية لرؤية المصفوفة المخصصة التي تم إرسالها بشكل متكرر.

## المراجع والشكر

- [进阶篇 IV [DMA]](https://alchemicronin.github.io/posts/90d72de/#4-0-%E7%BB%83%E4%B9%A0%E9%A1%B9%E7%9B%AE)
- [【STM32】HAL 库 STM32CubeMX 教程十一 ---DMA (串口 DMA 发送接收)](https://blog.csdn.net/as480133937/article/details/104827639)

> عنوان النص: <https://wiki-power.com/>  
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.
