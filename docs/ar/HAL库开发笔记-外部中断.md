# ملاحظات تطوير مكتبة HAL - المقاطع الخارجية

في المقالة السابقة ، أشرنا إلى أن استخدام الاستطلاع للقضاء على اهتزاز المفاتيح واستشعار الإدخال قد يستهلك موارد النظام بشكل زائد ويؤدي إلى تجميد النظام. قد يؤدي أيضًا إلى تفويت الكشف. هذا هو السبب في أننا بحاجة إلى استخدام المقاطع الخارجية.

## المبادئ الأساسية

### الاستطلاع مقابل المقاطع

ما هي الاستطلاع والمقاطع؟ لنأخذ مثالًا على طلب الطعام ، الاستطلاع هو عندما أذهب إلى الباب كل دقيقة لأرى ما إذا جاءت سيارة توصيل الطعام. خلال هذا الوقت ، لا يمكنني القيام بأي شيء آخر سوى مراقبة الباب ؛ لكن إذا حصل سائق توصيل الطعام على الباب في اللحظة التي غادرت فيها الباب بالفعل ، فقد فاتتني الطلب. على النقيض من ذلك ، المقاطعة هي عندما يتصل سائق توصيل الطعام عندما يصل ، لذا أضع الشيء الذي أفعله جانبًا وأذهب لاستلام الطلب. بهذه الطريقة ، يمكنني القيام بأعمالي بسلام وأنا لا أخشى تفويت الطلب.

### المقاطع الخارجية

تنقسم المقاطع إلى خارجية (Interrupt) وداخلية (Exception). المقاطع الخارجية تتسبب في تدخل وحدة المعالجة المركزية (MCU) من قِبل أجهزة خارجية ، بينما المقاطع الداخلية تتسبب في تدخل MCU من قِبل البرامج الداخلية.

### وحدة تحكم المقاطع المتداخلة

يعني اختصار NVIC وحدة تحكم المقاطع المتداخلة المتداخلة بالأقسام. تتضمن هذه الوحدة ثلاثة معاملات رئيسية: تمكين المقاطع ، أولوية الاحتكاك ، أولوية الاستجابة. (كلما كانت القيمة أقل ، كانت الأولوية أعلى)

![مثال](https://img.wiki-power.com/d/wiki-media/img/20210206121058.png)

**تمكين المقاطع**: يشير إلى ما إذا كانت المقاطع ممكنة. إذا تم تمكين المقاطع ، فعندما تتوافر شروط تنشيط المقاطع ، سيتم الانتقال إلى برنامج خدمة المقاطع. وإلا ، لن يتم مراعاة برنامج خدمة المقاطع وسيتم استمرار تشغيل البرنامج الرئيسي.

**أولوية الاحتكاك**: تُستخدم لتحديد ما إذا كان بإمكان مقاطعة ما أن تقاطع برنامج خدمة مقاطعة آخر. على سبيل المثال ، إذا كانت الشروط قد نشأت لمقاطعة A ، وبرنامج خدمة مقاطعة A قيد التشغيل ، وفي هذه اللحظة تم نشر شروط لمقاطعة B ، إذا كانت أولوية احتكاك مقاطعة B أعلى من A ، فإن برنامج خدمة مقاطعة B سيتم تنفيذه أولاً ، ثم يتم استئناف تنفيذ برنامج خدمة مقاطعة A. وهذا يُعرف أيضًا بتداخل المقاطع. إذا كانت أولوية احتكاك B لا تفوق A ، فاستكمل تنفيذ A أولاً ، ثم انتقل إلى B.

**أولوية الاستجابة**: إذا كانت هناك عدة مقاطع ممكنة لها نفس أولوية الاحتكاك وتم تنشيطها في نفس الوقت ، فإن مقاطعة ذات أولوية استجابة عالية ستتم تنفيذها أولاً.

لتحديد أولوية المقاطع ، يجب أن ن

![صورة](https://img.wiki-power.com/d/wiki-media/img/20210206134916.png)

بالإضافة إلى ذلك، يجب تخفيض أولوية الاستيلاء على المقاعد بمقعد واحد (من 0 إلى 1، وسيتم شرح السبب لاحقًا).

### تكوين المقاطعات في الشيفرة

كل ما عليك فعله هو إضافة الشيفرة التالية إلى نهاية `stm32f4xx_it.c`:

```c title="stm32f4xx_it.c"
/* USER CODE BEGIN 1 */

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    if(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == 0)
    {
        HAL_Delay(100);
        if(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == 0)
        {
            HAL_GPIO_TogglePin(LED1_GPIO_Port,LED1_Pin);
        }
    }
}

/* USER CODE END 1 */
```

هذا الشيفرة يقوم بإعادة كتابة دالة الاستدعاء الرجوعي للمقاطعة، ويضيف وظيفة لتبديل حالة الإضاءة باستخدام مفتاح. ولكن يجب مراعاة أن دالة التأخير `HAL_Delay()` في هذا الشيفرة تحتوي على انتقاد، لأنها تعتمد على مقاعد الاستيلاء للمقاطعات. من الواضح من الرسم البياني السابق لتكوين NVIC أن SysTick وأولوية الاستيلاء على المقاطعات التي قمنا بتكوينها هما على مقعدي 0، وهذا يعني أنه لن يتم استدعاء SysTick بعد استدعاء المقاطعة الخارجية. لذا، يجب تخفيض أولوية الاستيلاء على المقاطعات الخارجية (من 0 إلى 1).

بمجرد ترجمة وتحميل الشيفرة، ستتمكن من تبديل حالة الإضاءة بضغطة زر.

## المراجع والشكر

- [الجزء المتقدم II [المقاطعات]](https://alchemicronin.github.io/posts/ff6aca34/)
- [STM32CubeMX دليل عملي (الجزء الثالث) - المقاطعات الخارجية (مع التجنب من مشكلة المقاعد ودالة HAL_Delay)](https://blog.csdn.net/weixin_43892323/article/details/104383560?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control)

> عنوان النص: <https://wiki-power.com/>  
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.