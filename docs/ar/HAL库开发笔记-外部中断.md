# مذكرات تطوير مكتبة HAL - المقاطعات الخارجية

في المقالة السابقة ، ذكرنا أن استخدام الاستطلاع لإزالة اهتزاز المفاتيح والكشف عن المدخلات قد يستهلك موارد النظام الزائدة ويؤدي إلى تعليق النظام ، وقد يفوت الكشف. هذا هو السبب في أننا بحاجة إلى استخدام المقاطعات.

## المبادئ الأساسية

### الاستطلاع والمقاطعات

ما هي الاستطلاع والمقاطعات؟ لنأخذ مثالًا على طلب الطعام ، الاستطلاع هو أنني أذهب إلى الباب كل دقيقة لأرى هل وصل سائق الطعام أم لا. في هذه الفترة ، لا يمكنني القيام بأي شيء آخر ، فقط أنظر إلى الطعام. ولكن إذا وصل سائق الطعام في الوقت الذي غادرت فيه الباب ، فسوف تفوتني الطعام. على العكس ، المقاطعات هي عندما يتصل سائق الطعام عندما يأتي ، أضع العمل الذي أقوم به جانبًا لأخذ الطعام ، بحيث يمكنني العمل بشكل آمن ولا يوجد خطر فوات الطعام.

### المقاطعات الخارجية

تنقسم المقاطعات إلى خارجية (مقاطعة) وداخلية (استثناء). المقاطعات الخارجية تتم عن طريق جهاز خارجي يقوم بإيقاف تشغيل MCU ، بينما تتم المقاطعات الداخلية عن طريق برنامج البرامج الثابتة الداخلية التي تقوم بإيقاف تشغيل MCU.

### NVIC

يعني NVIC بالكامل Nested Vectored Interrupt Controller ، وترجمتها هي **متحكم المقاطعات المتجهة المتداخلة**. لديها ثلاثة معلمات رئيسية ، وهي: تمكين المقاطعات ، أولوية الاستيلاء ، وأولوية الاستجابة. (كلما كانت قيمة الأولوية أقل ، كانت الأولوية أعلى)

![](https://wiki-media-1253965369.cos.ap-guangzhou.myqcloud.com/img/20210206121058.png)

**تمكين المقاطعات**: يشير إلى ما إذا كانت المقاطعات مفتوحة. إذا تم تمكين المقاطعات ، فعندما يتم تلبية شرط تشغيل المقاطعات ، سيتم الانتقال إلى برنامج خدمة المقاطعات. وإلا ، فلن يتم النظر في برنامج خدمة المقاطعات ، وسيتم استمرار تشغيل البرنامج الرئيسي.

**أولوية الاستيلاء**: يستخدم لتحديد ما إذا كانت المقاطعة يمكن أن تقاطع برنامج خدمة المقاطعات الآخر ، وتشغيلها بشكل مسبق. على سبيل المثال ، إذا تم تلبية شرط A المقاطعة ، ويتم تشغيل برنامج خدمة المقاطعات A ، وفي هذا الوقت تم تلبية شرط B المقاطعة ، إذا كانت أولوية استيلاء المقاطعة B أعلى من A ، فسيتم إيقاف تشغيل برنامج خدمة المقاطعات A ، والذهاب لتشغيل برنامج خدمة المقاطعات B ، وبعد الانتهاء من ذلك ، يتم استئناف تشغيل A ، ويشار إلى هذا باسم المقاطعات المتداخلة. إذا كانت أولوية استيلاء المقاطعة B لا تزال أقل من A ، فلا يزال يجب إكمال A بالكامل قبل الانتقال إلى B.

**أولوية الاستجابة**: إذا تم تشغيل عدة مقاطعات في نفس الوقت وكانت أولوية استيلاءها متساوية ، فسيتم تشغيل المقاطعة التي لديها أولوية استجابة أعلى أولاً.

لتحديد أولوية المقاطعة ، يجب أولاً مقارنة أولوية الاستيلاء. في حالة تساوي أولوية الاستيلاء ، فإن المقاطعة التي لديها أولوية استجابة أعلى لها أولوية أعلى. إذا كانت الأولويات متساوية ، فيجب استخدام جدول المقاطعات المتجهة لتحديد ذلك.

### مرجع دالة الاستدعاء العائدة للمقاطعات

بعد تكوين المقاطعات GPIO وأولوية NVIC ، يمكن تحقيق الوظيفة عن طريق إعادة كتابة دالة الاستدعاء العائدة للمقاطعات في ملف `stm32f4xx_it.c`.

```c
/* USER CODE BEGIN 1 */

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{

}

/* USER CODE END 1 */
```

## تحكم الأزرار الخارجية في الإضاءة

قبل القيام بالتجربة التالية ، يجب تكوين جميع المعلمات المختلفة في CubeMX ، مثل تنزيل المنفذ التسلسلي ، والساعة ، وما إلى ذلك.  
يرجى الرجوع إلى المقالة [**مذكرات تطوير مكتبة HAL - تكوين البيئة**](https://wiki-power.com/ar/HAL%E5%BA%93%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE) للحصول على الخطوات المحددة.

### تكوين المقاطعات في CubeMX

![](https://wiki-media-1253965369.cos.ap-guangzhou.myqcloud.com/img/20210205150422.png)

كما هو موضح في الصورة ، لا يزال يتم تكوين LED باستخدام الطريقة المذكورة في المقالة السابقة ، ويتم تكوين دبوس المفتاح كمقاطعة تنشيطها من الجهد المنخفض ، وهي تنتج حافة هابطة عند الضغط. بناءً على الرسم البياني ، يتم تحديد المقاطعة على أنها وضع `GPIO_EXTI8` (مقاطعة خارجية ، معلقة على خط المقاطعة 8) ، وتم تكوينها لتنتج حافة هابطة ، وفقًا للرسم البياني ، يتم اختيار السحب الداخلي (Pull-up) . كما هو موضح في الصورة:

![](https://wiki-media-1253965369.cos.ap-guangzhou.myqcloud.com/img/20210403222304.png)

![](https://wiki-media-1253965369.cos.ap-guangzhou.myqcloud.com/img/20210206131409.png)

ثم ، انقر فوق العلامة التبويب NVIC لتمكين المقاطعة التي تم تكوينها:

![](https://wiki-media-1253965369.cos.ap-guangzhou.myqcloud.com/img/20210206134916.png)

بالإضافة إلى ذلك ، يجب تخفيض أولوية الاستيلاء بمقدار واحد (من 0 إلى 1 ، وسيتم شرح السبب في النص التالي).

### تكوين المقاطع في الكود

يتم إضافة الكود التالي فقط في نهاية `stm32f4xx_it.c`:

```c
/* USER CODE BEGIN 1 */

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{

}

/* USER CODE END 1 */
```

```c title="stm32f4xx_it.c"
/* USER CODE BEGIN 1 */

void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    if(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == 0)
    {
        HAL_Delay(100);
        if(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == 0)
        {
            HAL_GPIO_TogglePin(LED1_GPIO_Port,LED1_Pin);
        }
    }
}

/* USER CODE END 1 */
```

يقوم هذا الكود بإعادة كتابة دالة استدعاء التقاطعات وإضافة وظيفة تبديل الإضاءة باستخدام زر. ولكن توجد مشكلة في دالة التأخير `HAL_Delay()`، حيث أنها تعتمد على مؤقت SysTick (ينتج تقاطعات في فترات زمنية ثابتة)، وبالتالي لها أولوية تقاطع محددة. يمكن ملاحظة أن SysTick وأولوية التقاطع المكونة مناختيارنا لم يتم تحديدها بشكل صحيح في صورة NVIC المكونة مناختيارنا، حيث أن SysTick وأولوية التقاطع المكونة مناختيارنا هما 0، وبالتالي لا يمكن تنشيط SysTick بعد تنشيط التقاطع الخارجي. لذلك، يجب تغيير أولوية التقاطع الخارجي (من 0 إلى 1).

بعد الترجمة والتحميل، يمكن تبديل حالة الإضاءة عن طريق الضغط على الزر.

## المراجع والشكر

- [الجزء المتقدم II [التقاطعات]](https://alchemicronin.github.io/posts/ff6aca34/)
- [STM32CubeMX دليل التطبيق العملي (الجزء الثالث) - التقاطعات الخارجية (تجنب التأخير في دالة HAL_Delay)](https://blog.csdn.net/weixin_43892323/article/details/104383560?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control)

> عنوان النص: <https://wiki-power.com/>  
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.
