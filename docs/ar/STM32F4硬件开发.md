# تطوير الأجهزة الصلبة لـ STM32F4

سيتم في هذه المقالة شرح أدنى نظام لـ MCU STM32F4 (الطاقة والساعة وإعادة التعيين ووضع البدء وإدارة التصحيح).

## الطاقة

الجهد العادي لعمل STM32F4 هو 1.8-3.6 فولت (قد ينخفض في بعض الحالات إلى أقل من 1.7 فولت ، وفقًا للكتيبات الفنية) ، ويوفر مثبت الجهد الداخلي 1.2 فولت للطاقة الرقمية الداخلية.

عندما يتم فصل الطاقة الرئيسية VDD ، يمكن توفير الطاقة لمؤقت الوقت الحقيقي (RTC) والسجلات الاحتياطية عن طريق جهد VBAT.

### مقدمة للأقطاب المختلفة

#### مصدر الطاقة والجهد المرجعي للمحول الرقمي التناظري

لتحسين دقة التحويل ، يحتوي ADC على أقطاب طاقة مستقلة يمكن تصفيتها وحجب الضوضاء على PCB.

يتم إدخال مصدر الجهد ADC من الدبوس VDDA المستقل. عند تصميم الدائرة ، يجب توصيل VSSA بنفس الأرضية الكهربائية المزودة ، وليس VSS.

إذا كانت حزمة الشريحة أكثر من 100 دبوس ، فسيكون هناك دبوس VREF + و VREF- ، والتي تستخدم لإدخال الجهد المرجعي الخارجي لـ ADC. يجب توصيل VREF- بـ VSSA الداخلية. إذا كان عدد دبابيس الشريحة أقل من 100 ، فلن يتم توصيل هذين الدبوسين ، وسيتم توصيلهما داخليًا بـ VDDA و VSSA.

#### مصدر الطاقة الاحتياطية للبطارية

إذا كنت بحاجة إلى الاحتفاظ بمحتويات سجلات الاحتياطية بعد فصل VDD ، فيمكن توصيل VBAT بالبطارية أو مصدر طاقة آخر.

يمكن أيضًا استخدام VBAT لتوفير الطاقة لـ RTC ، ويتم التحكم فيها من خلال دائرة إعادة التعيين الداخلية في وحدة إعادة التعيين (PDR).

#### مثبت الجهد الداخلي

يتم تمكين مثبت الجهد الداخلي بعد إعادة التعيين ، ويوجد لديه ثلاثة أنماط عمل:

- تشغيل: يوفر المثبت الجهد الكامل (للنواة والذاكرة والأجهزة الرقمية الخارجية) لمجال 1.2 فولت.
- إيقاف: يوفر المثبت الجهد الكامل (للنواة والذاكرة والأجهزة الرقمية الخارجية) لمجال 1.2 فولت ، وفي الوقت نفسه يحتفظ بمحتويات السجلات والذاكرة العشوائية SRAM.
- وضع الاستعداد: يتم فصل المثبت الجهد. سيتم فقدان محتويات السجلات والذاكرة العشوائية SRAM باستثناء دائرة الاستعداد ومجال الاحتياطي.

### تصميم الدائرة

فيما يلي طريقة تصميم أقطاب الطاقة:

- **VDD**
  - **التحويل الكهربائي**: سعة 10 ميكروفاراد الإجمالية من السيراميك / التانتالوم ، بالإضافة إلى سعة 100 نانوفاراد من السيراميك لكل دبوس VDD.
- **VDDA**
  - **التحويل الكهربائي**: سعة 100 نانوفاراد من السيراميك + سعة 1 ميكروفاراد من السيراميك / التانتالوم.
  - **تصفية الضوضاء التناظرية**: يمكن توصيلها بـ VDD عن طريق الخرز المغناطيسي.
- **VREF +**
  - **التحويل الكهربائي**: إذا تم تمكين وظيفة VREF + ، فيجب توصيل سعة 100 نانوفاراد وسعة 1 ميكروفاراد.
  - **تصفية الضوضاء التناظرية**: يمكن توصيلها بـ VDDA عن طريق مقاومة 47 أومًا.
- **VBAT**: توصيل البطارية الخارجية (1.65-3.6 فولت). إذا لم يكن هناك حاجة لمصدر الطاقة الاحتياطية ، فتوصيلها بدبوس VDD.
- **VCAP1 / VCAP2**: توصيل كل منها بالأرض بسعة 2.2 ميكروفاراد من السيراميك (ESR <2 أوم) ؛ إذا كان هناك VCAP1 فقط ، فتوصيل سعة 4.7 ميكروفاراد من السيراميك (ESR <1 أوم).

### إعادة التعيين ومراقبة الطاقة

#### إعادة التعيين عند الطاقة على / إيقاف التشغيل

![](https://img.wiki-power.com/d/wiki-media/img/20210529143014.png)

يتم دمج دائرة POR / PDR في رقاقة STM32F4 ، وتتميز بميزات إعادة التعيين عند الطاقة على / إيقاف التشغيل كما هو موضح في الشكل أعلاه. إذا كنت ترغب في تعطيل هذه الميزة ، فيمكن تحقيق ذلك عن طريق دبوس PDR_ON.

#### إعادة تعيين النظام

شروط إعادة تعيين النظام:

- NRST دبوس الجهد المنخفض (إعادة تعيين خارجي)
- انتهاء عداد مراقبة الوقت الحقيقي (إعادة تعيين WWDG)
- انتهاء عداد مراقبة الوقت الحقيقي المستقل (إعادة تعيين IWDG)
- إعادة تعيين البرامج الثابتة (إعادة تعيين SW)
- إعادة تعيين إدارة الطاقة المنخفضة

![](https://img.wiki-power.com/d/wiki-media/img/20210529143925.png)

يمكن تحديد مصدر إعادة التعيين من خلال عرض العلامات في سجل التحكم / الحالة (RCC_CSR).

حتى إذا لم يكن هناك دائرة إعادة تعيين خارجية ، فمن المستحسن أيضًا إضافة سعة تفريغ لتحسين أداء EMS.

## الساعة

يمكن استخدام ثلاثة مصادر ساعة مختلفة لتشغيل ساعة النظام (SYSCLK) على STM32F4:

- HSI (إشارة الساعة الداخلية عالية السرعة)
- HSE (إشارة الساعة الخارجية عالية السرعة)
- ساعة PLL

هناك أيضًا مصدران ثانويان للساعة:

- LSI (إشارة الساعة الداخلية المنخفضة السرعة)
- LSE (إشارة الساعة الخارجية المنخفضة السرعة)



- LSI RC (32 kHz low-speed internal RC)، يستخدم لتشغيل المراقب الذاتي للبوابة ويمكن استخدامه أيضًا في وضع إيقاف التشغيل / الاستعداد للمنبه التلقائي RTC.
- LSE (32.768 kHz low-speed external crystal oscillator)، يستخدم لتشغيل RTC.

إذا كنت بحاجة إلى تقليل استهلاك الطاقة ، فيمكن إيقاف كل ساعة عند عدم الاستخدام.

### ساعة خارجية عالية السرعة (HSE)

يمكن توفير مصدر ساعة HSE بطريقتين: مصدر خارجي (نشط) ومنبع خارجي للكريستال / الموجات الصوتية السيراميكية (غير نشط).

![](https://img.wiki-power.com/d/wiki-media/img/20210529145726.png)

#### مصدر خارجي (تجاوز HSE)

إذا تم اختيار إدخال إشارة ساعة خارجية نشطة ، فيجب توفير مصدر ساعة بتردد 1-50 ميجاهرتز ، يتصل OSC_IN بإشارة ساعة خارجية (موجة مربعة أو موجة جيبية أو موجة مثلثة) بنسبة حجم 50٪ ، ويتم الاحتفاظ بـ OSC_OUT في حالة عالية المقاومة.

#### كريستال HSE الخارجي / موجات صوتية سيراميكية (كريستال HSE)

إذا تم اختيار الكريستال الخارجي ، فسيكون نطاق التردد من 4-26 ميجاهرتز. عند تصميم الدائرة ، يجب أن يتم وضع مكثف الحمل والمكثف الكهربائي قريبين قدر الإمكان من دبوس المذبذب لتقليل التشويش في الإخراج وزمن الاستقرار. يجب تعديل قيمة مكثف الحمل بناءً على المذبذب المختار.

يجب استخدام مكثف CL1 و CL2 بحجم متساوٍ (5-25 بيكوفاراد ، قيمة نموذجية 25 بيكوفاراد) من المكثفات السيراميكية.

### ساعة خارجية منخفضة السرعة (LSE)

يمكن توفير مصدر ساعة LSE بطريقتين: مصدر خارجي (نشط) ومنبع خارجي للكريستال / الموجات الصوتية السيراميكية (غير نشط).

![](https://img.wiki-power.com/d/wiki-media/img/20210529152354.png)

#### مصدر خارجي (تجاوز LSE)

إذا تم اختيار إدخال إشارة ساعة خارجية نشطة ، فيجب توفير مصدر ساعة بتردد أقل من 1 ميجاهرتز ، يتصل OSC32_IN بإشارة ساعة خارجية (موجة مربعة أو موجة جيبية أو موجة مثلثة) بنسبة حجم 50٪ ، ويتم الاحتفاظ بـ OSC32_OUT في حالة عالية المقاومة.

#### كريستال LSE الخارجي / موجات صوتية سيراميكية (كريستال LSE)

إذا تم اختيار الكريستال الخارجي ، فسيكون نطاق التردد 32.768 كيلوهرتز ، ويمكن استخدامه كمصدر ساعة RTC. عند تصميم الدائرة ، يجب أن يتم وضع مكثف الحمل والمكثف الكهربائي قريبين قدر الإمكان من دبوس المذبذب لتقليل التشويش في الإخراج وزمن الاستقرار. يجب تعديل قيمة مكثف الحمل بناءً على المذبذب المختار.

## وضع البدء

وضع البدء أو وضع الإقلاع. يمكن اختيار ثلاثة أنماط مختلفة لوضع البدء عن طريق توصيل دبوسي BOOT0 و BOOT1: البدء من ذاكرة التخزين الفلاش الرئيسية ، البدء من ذاكرة التخزين النظامية ، البدء من SRAM المدمج.

لمزيد من التفاصيل حول وضع البدء ، يرجى الرجوع إلى المقالة [**وضع البدء لـ STM32**](https://wiki-power.com/ar/وضع البدء لـ STM32)

عادةً ما نستخدم مقاومة سحب 10 كيلو أوم على BOOT0 ، ويمكن ترك BOOT1 بأي شكل من الأشكال. إذا كنت بحاجة إلى تغيير وضع البدء ، فيمكنك الاستشارة التصميم التالي:

![](https://img.wiki-power.com/d/wiki-media/img/20200605163537.png)

## إدارة التصحيح

عادةً ما يتم استخدام بروتوكول SWJ لتنزيل التصحيح لـ STM32.

### منفذ تصحيح SWJ

يحتوي STM32F4 على واجهة SWJ (SW / JTAG) المدمجة. يتكون SW-DP من 2 دبوس (ساعة + بيانات) ، و JTAG-DP من 5 دبوس ، وبعض الدبابيس متعددة الاستخدام. لمزيد من التفاصيل ، يرجى الرجوع إلى المقالة [**الفرق والاتصال بين SWD و JTAG**](https://wiki-power.com/ar/الفرق والاتصال بين SWD و JTAG)

في STM32F4 ، يتم تخصيص دبابيس SWJ على النحو التالي:

![](https://img.wiki-power.com/d/wiki-media/img/20210529210858.png)

### السحب الداخلي والخارجي لـ JTAG

لا يمكن ترك دبابيس JTAG معلقة (لأنها متصلة مباشرة بمشغلات التحكم في التصحيح المستخدمة للتحكم في الوضع) ، لذلك يتم دمج السحب الداخلي والخارجي لها داخل الشريحة:

- **JNTRST**: سحب داخلي
- **JTDI**: سحب داخلي
- **JTMS / SWDIO**: سحب داخلي
- **TCK / SWCLK**: سحب خارجي

عندما يتم إطلاق سراح برنامج JTAG I/O ، يمكن استخدامه كمنفذ I/O عادي.

### تصميم الأجهزة المتصلة بمقعد JTAG القياسي

![](https://img.wiki-power.com/d/wiki-media/img/20210529211840.png)

## التصميم المرجعي

![](https://img.wiki-power.com/d/wiki-media/img/20210529213723.png)

## المراجع والشكر

- [AN4488: البدء في تطوير الأجهزة لمعالجات STM32F4xxxx](https://www.st.com/content/ccc/resource/technical/document/application_note/76/f9/c8/10/8a/33/4b/f0/DM00115714.pdf/files/DM00115714.pdf/jcr:content/translations/en.DM00115714.pdf)

> عنوان النص: <https://wiki-power.com/>  
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.