# مذكرات تطوير مكتبة HAL - المؤقت TIM العام

في المقال السابق، تم تقديم لمحة مبسطة حول ثلاث فئات من مؤقتات STM32F4، وشرح مفصل للمؤقت الأساسي. في هذا المقال، سنستمر في استعراض المؤقت العام.

## المبادئ الأساسية

في STM32F4، المؤقت العام متاح بالفئات TIM2-TIM5 وTIM9-TIM14.

### ميزات المؤقت العام

في STM32F4، تتميز المؤقتات العامة بالميزات التالية:

- مُعدل/مُنقّص 16/32 بت وعداد تكراري تلقائي للزيادة والنقص والزيادة/النقص.
- مُقسِّم يمكن برمجته بـ 16 بت لتقسيم تردد العداد (القيمة المُقسَّمة تتراوح بين 1 و 65536).
- 4 قنوات مستقلة تُستخدم على التوالي للقبض على الإشارات، ومقارنة الإخراج، وتوليد PWM (وضعيات الحافة والمركز)، والإخراج بنمط نبضة واحدة.
- إمكانية التحكم في المؤقت باستخدام إشارة خارجية والتزامن بين عدة مؤقتات.
- إصدار طلبات انقطاع/ DMA عند حدوث الأحداث التالية:
  - التحديث: تجاوز/عدم توافر العداد، بدء تهيئة العداد (برمجيًا أو بواسطة مؤشر/تفجير داخلي/خارجي).
  - حدث الإشعال (بدء/إيقاف/تهيئة العداد بواسطة العداد الداخلي/الخارجي).
  - القبض على الإشارة.
  - مقارنة الإخراج.
- دعم الكودير المُزيّن (الزيادة المُشفَرة) ودوائر الاستشعار هول.
- إدخال مصدر العداد الخارجي أو التحكم الكهربائي دوري.

### مراجع وظائف المؤقت الشائعة

فيما يلي مراجع لوظائف المؤقت الشائعة، وهي مماثلة لوظائف المؤقت الأساسي.

- **HAL_TIM_Base_Init()**: تهيئة وحدة الزمن الأساسية.
- **HAL_TIM_Base_DeInit()**: تعطيل المؤقت، عكس الإعداد.
- **HAL_TIM_Base_MspInit()**: دالة التهيئة MSP، يتم استدعاؤها تلقائيًا عند بدء تهيئة المؤقت.
- **HAL_TIM_Base_MspDeInit()**: عكس السابق.
- **HAL_TIM_Base_Start()**: تشغيل المؤقت.
- **HAL_TIM_Base_Stop()**: إيقاف المؤقت.
- **HAL_TIM_Base_Start_IT()**: تشغيل المؤقت بوضع الانقطاع.
- **HAL_TIM_Base_Stop_IT()**: إيقاف المؤقت في وضع الانقطاع.
- **HAL_TIM_Base_Start_DMA()**: تشغيل المؤقت بوضع DMA.
- **HAL_TIM_Base_Stop_DMA()**: إيقاف المؤقت في وضع DMA.

## إنتاج إشارة PWM بتردد 1 كيلوهرتز ونسبة تشغيل 50%

في هذه التجربة، سنستخدم المؤقت العام لإنتاج إشارة PWM بتردد 1 كيلوهرتز ونسبة تشغيل 50%، وسيمكننا من رؤية الموجة المُنتَجة باستخدام جهاز الاستشعار.

### تكوين المؤقت العام داخل CubeMX

أولاً، سنقوم بفتح صفحة تكوين الساعة وشجرة الساعة (Clock Configuration)، ونظرًا لأن المؤقت العام مُوصول بالحافلة السريعة APB2، سنجد ونسجّل تردد ساعات APB2 (180 ميجا هرتز):

![صورة](https://img.wiki-power.com/d/wiki-media/img/20210627133951.png)

ثم، سنجد المؤقت TIM8 في الجانب الأيسر ونقوم بتكوين القناة 1 (`Channel 1`) لإنتاج إشارة PWM (`PWM Generation CH1`). لإنتاج موجة مربعة بتردد 1 كيلوهرتز، يجب تكوين المعلمات التالية:

- **Prescaler** (عامل القسمة

```markdown
قم بترجمة النص إلى العربية:

```c
HAL_TIM_PWM_Start(&htim8,TIM_CHANNEL_1);

// ضبط نسبة النبض إلى 500 (500 هرتز / 1 كيلو هرتز = 50%)
__HAL_TIM_SetCompare(&htim8,TIM_CHANNEL_1,500);

/* USER CODE END 2 */
```

قم بترجمة النص إلى العربية:

```markdown
قم بترجمة النص إلى العربية:

```c
HAL_TIM_PWM_Start(&htim8,TIM_CHANNEL_1);

// ضبط نسبة النبض إلى 500 (500 هرتز / 1 كيلو هرتز = 50%)
__HAL_TIM_SetCompare(&htim8,TIM_CHANNEL_1,500);

/* USER CODE END 2 */
```

بعد ذلك، يمكنك القيام بعملية الترجمة من الإنكليزية إلى العربية بنجاح. هل يمكنني مساعدتك بمزيد من المعلومات؟
```

تم الترجمة والمساعدة. إذا كنت بحاجة إلى مزيد من المساعدة أو لديك أي استفسارات أخرى، فلا تتردد في طرحها.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.