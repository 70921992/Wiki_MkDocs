# مذكرات تطوير مكتبة HAL - المؤقت العام TIM

في المقالة السابقة، تم تقديم ثلاثة أنواع من المؤقتات في STM32F4 وشرح المؤقت الأساسي بالتفصيل. في هذه المقالة، سنواصل شرح المؤقت العام.

## المبدأ الأساسي

في STM32F4، يوجد مؤقتات عامة TIM2-TIM5 و TIM9-TIM14.

### خصائص المؤقت العام

في STM32F4، تتميز المؤقتات العامة بالخصائص التالية:

- عداد تصاعدي / تنازلي 16/32 بت وعداد تكراري تصاعدي / تنازلي
- مقسم قابل للبرمجة بـ 16 بت لتقسيم تردد ساعة العداد (معامل القسمة 1-65536)
- 4 قنوات مستقلة يمكن استخدامها للتالي:
  - الاستحواذ على الإدخال
  - المقارنة الناتجة
  - إنتاج PWM (وضع الحافة والتوازن المركزي)
  - إخراج وضع النبض الفردي
- استخدام إشارة خارجية للتحكم في المؤقت وتنفيذ دوائر مزامنة متعددة للمؤقتات
- توليد طلبات انقطاع / DMA عند حدوث الأحداث التالية:
  - التحديث: تجاوز / تحت العداد ، تهيئة العداد (عن طريق البرنامج أو التشغيل الداخلي / الخارجي)
  - حدث الزناد (تشغيل العداد ، إيقافه ، تهيئته أو تشغيل العداد عن طريق التشغيل الداخلي / الخارجي)
  - الاستحواذ على الإدخال
  - المقارنة الناتجة
- دعم الترميز الزيادي (المتوازي) للمحركات ودوائر الاستشعار هول
- إدخال تشغيل الساعة الخارجية أو إدارة التيار الدوري

### مراجع الدوال الشائعة للمؤقت

هذه هي مراجع الدوال الشائعة للمؤقت، وهي مماثلة لدوال المؤقت الأساسي.

- **HAL_TIM_Base_Init()**: تهيئة وحدة المؤقت الأساسية
- **HAL_TIM_Base_DeInit()**: تعطيل المؤقت، عكس التهيئة
- **HAL_TIM_Base_MspInit()**: دالة MSP التهيئة، سيتم استدعاؤها تلقائيًا عند تهيئة المؤقت
- **HAL_TIM_Base_MspDeInit()**: عكس السابق
- **HAL_TIM_Base_Start()**: تشغيل المؤقت
- **HAL_TIM_Base_Stop()**: إيقاف المؤقت
- **HAL_TIM_Base_Start_IT()**: تشغيل المؤقت بوضع الانقطاع
- **HAL_TIM_Base_Stop_IT()**: إيقاف المؤقت بوضع الانقطاع
- **HAL_TIM_Base_Start_DMA()**: تشغيل المؤقت بوضع DMA
- **HAL_TIM_Base_Stop_DMA()**: إيقاف المؤقت بوضع DMA

## إخراج إشارة PWM بتردد 1 كيلو هرتز ونسبة تشغيل 50٪ باستخدام المؤقت العام

في هذه التجربة، سنستخدم المؤقت العام لإخراج إشارة PWM بتردد 1 كيلو هرتز ونسبة تشغيل 50٪، ويمكن عرض الموجة الناتجة باستخدام جهاز الاهتزاز.

### تكوين المؤقت العام داخل CubeMX

أولاً، نفتح صفحة تكوين شجرة الساعة Clock Configuration، ونجد تردد ساعة APB2 Timer clocks (180 ميجا هرتز) لأن المؤقت العام مرتبط بشبكة APB2 عالية السرعة، ونحتفظ به:

![](https://f004.backblazeb2.com/file/wiki-media/img/20210627133951.png)

ثم، نجد المؤقت العام TIM8 في الجانب الأيسر من الشاشة، ونقوم بتعيين القناة 1 (Channel 1) كإنتاج PWM (PWM Generation CH1). لإنتاج موجة مربعة PWM بتردد 1 كيلو هرتز، نقوم بتكوين المعلمات التالية:

- **Prescaler** (معامل القسمة): 180-1
- **Counter Mode** (وضع العداد): Up (يبدأ العداد من الصفر ويتصاعد حتى يتم الفيض)
- **Counter Period** (فترة العداد / قيمة التحميل): 1000-1
- **auto-reload preload** (إعادة تحميل تلقائي): Enable (سيتم إعادة تحميل القيمة الأولية عند الفيض)

![](https://f004.backblazeb2.com/file/wiki-media/img/20210627153422.png)

وبما أن المصدر المستخدم هو 180 ميجا هرتز، فإننا نقوم بتعيين معامل القسمة على 180-1 = 179، وبعد القسمة، يصبح التردد 1 ميجا هرتز، ونقوم بتعيين قيمة التحميل على 1000-1 = 9999، وبالتالي يتم الحصول على تردد 1 كيلو هرتز.

### تكوين المؤقت العام في الكود

نقوم بتشغيل المؤقت في `main.c`:

```c title="main.c"
/* USER CODE BEGIN 2 */

HAL_TIM_PWM_Start(&htim8,TIM_CHANNEL_1);

// تعيين نسبة العرض إلى 500 (500 هرتز / 1 كيلو هرتز = 50٪)
__HAL_TIM_SetCompare(&htim8,TIM_CHANNEL_1,500);

/* USER CODE END 2 */
```

قم بترجمة وحرق البرنامج ، يمكنك رؤية الموجة باستخدام المحلل الطيفي:

![](https://f004.backblazeb2.com/file/wiki-media/img/20210627154737.jpg)

## المراجع والشكر

- [STM32CubeMX 实战教程（五）—— 通用定时器（PWM 输出）](https://blog.csdn.net/weixin_43892323/article/details/104776035)

> عنوان النص: <https://wiki-power.com/>  
> يتم حماية هذا المقال بموجب اتفاقية [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by/4.0/deed.zh)، يُرجى ذكر المصدر عند إعادة النشر.

> تمت ترجمة هذه المشاركة باستخدام ChatGPT، يرجى [**تزويدنا بتعليقاتكم**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) إذا كانت هناك أي حذف أو إهمال.