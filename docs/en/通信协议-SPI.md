# Communication Protocol - SPI

SPI (Serial Peripheral Interface) is a **full-duplex, synchronous, serial, master/slave, bus** communication protocol with a data transfer rate of 8 Mbit. SPI can only have one master and can connect to one or more slaves. When connecting multiple devices, chip select (CS) pins are required.

![](https://img.wiki-power.com/d/wiki-media/img/20210911095950.png)

## SPI Pins

- **SCLK** (serial clock): a clock signal driven by the master, sampled as input by the slave. The signals on SDO and SDI are latched based on the clock signal on SCLK. One clock cycle transfers 1 bit of data, so the transfer rate is equal to the clock frequency generated by the master.
- **SDI/SDO** (serial data in / serial data out): describes the direction of the data flow relative to the master, but more often MOSI (Master Out Slave In) and MISO (Master In Slave Out) appear on the board. Correspondingly, SDO is MOSI on the master and MISO on the slave, while SDI is MISO on the master and MOSI on the slave. In a daisy chain topology, the MISO of device A is connected to the MISO of device B.
- **CS/SS** (chip select / slave select): driven by the master, used to arbitrate the priority of communication on the SPI bus. When the CS line is low, SPI communication is activated. CS is active low.

## SPI Data Latching

- SPI data is latched on the rising or falling edge of SCLK.
- The edge that latches the data is called the critical edge.
- For example, the left image below represents latching logic `1` on the rising edge of SDO, and the right image represents latching logic `0` on the falling edge.

![](https://img.wiki-power.com/d/wiki-media/img/20211026151750.png)

## SPI Read Segment Example

1. The critical edge is the rising edge.
2. The master outputs to the slave (SDI on the slave).
3. The CS pin is pulled low to 0V to activate SPI.
4. Data is transmitted in order from the most significant bit (MSB) to the least significant bit (LSB) on the rising edge of SCLK.
5. Data transmission is complete: `1011001`

![](https://img.wiki-power.com/d/wiki-media/img/20211026152228.png)

## SPI Critical Edge

- $t_{SU}$ (setup time): defines how long before the critical edge event, the SDI data should be determined and stabilized.
- $t_{HO}$ (hold time): defines how long the data on SDI must be retained after the critical edge event.
- $t_{DO}$ (delay time): defines the delay time of the valid data on SDO after the critical edge event.

![](https://img.wiki-power.com/d/wiki-media/img/20211026160940.png)

## SPI Transfer Modes (4 types)

- **CPOL** (clock polarity): the polarity of the idle (no data transfer) clock, where `0` represents low level and `1` represents high level.
- **CPHA** (clock phase): defines whether the latch occurs on the rising or falling edge. `0` represents latching on the first changing edge, and `1` represents latching on the second changing edge.

| Mode Number | CPOL (Clock Polarity) | CPHA (Clock Phase)       | Latch Edge |
| ----------- | --------------------- | ------------------------ | ---------- |
| 0           | 0 (Low Level)         | 0 (Latch on First Edge)  | Rising     |
| 1           | 0 (Low Level)         | 1 (Latch on Second Edge) | Falling    |
| 2           | 1 (High Level)        | 0 (Latch on First Edge)  | Falling    |
| 3           | 1 (High Level)        | 1 (Latch on Second Edge) | Rising     |

![](https://img.wiki-power.com/d/wiki-media/img/20211026162028.png)

## Daisy Chain

![](https://img.wiki-power.com/d/wiki-media/img/20211026164011.png)

In normal mode, each slave in SPI requires a CS line. When there are many slaves, it will occupy too many IO ports of the host. By using the topology connection of the daisy chain, only one CS line can be used to drive all slaves.

The principle of the daisy chain is that data is transmitted from the host to the first slave, and then from the first slave to the second slave, and so on, and the data is cascaded along the line until the last slave in the series, and the last slave transmits the data to the host through SDO.

## Advantages and Disadvantages of SPI

Advantages:

- Full-duplex communication
- Push-pull drive, can provide better signal integrity and higher speed
- Flexible protocol, not limited to 8-bit per byte
- Simple hardware design
  - No pull-up resistors are required, so the power consumption is lower
  - There is no arbitration mechanism or related failure mode
  - The slave does not require a clock (provided by the host)
  - The slave device does not require a separate address
  - No transceiver is required
  - The signals are unidirectional, making it easy to isolate currents
- There is no upper limit on the clock rate

Disadvantages:

- More pins are used than I2C
- The slave cannot perform hardware acknowledgment
- There is no error checking mechanism, such as parity check bit in UART
- Only one master can be used
- The specification is not uniform, and consistency cannot be verified
- The transmission distance is relatively short (compared to CAN, RS232, RS485, etc.)

## References and Acknowledgments

- "Analog Engineer's Pocket Reference"

> This post is translated using ChatGPT, please [**feedback**](https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new) if any omissions.
